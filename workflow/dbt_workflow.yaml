
id: dbt_build
namespace: com.example.dbt
description: "Executes dbt build command with MotherDuck connection"

tasks:
  - id: working_dir
    type: io.kestra.core.tasks.flows.WorkingDirectory
    tasks:
      - id: git_clone
        type: io.kestra.plugin.git.Clone
        url: https://github.com/pocky13/kestra_dbt_sample
        branch: main
        directory: .

      - id: dbt_build
        type: io.kestra.plugin.dbt.cli.DbtCLI
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: ghcr.io/kestra-io/dbt-duckdb:latest
        projectDir: ./kestra_dbt
        profiles: |
          kestra_dbt:
            target: dev
            outputs:
              dev:
                type: duckdb
                disable_transactions: false
                path: md:dbt_sample?motherduck_token={{ secret('MOTHERDUCK_TOKEN') }}
                fixed_retries: 1
                threads: 4
                timeout_seconds: 300
        commands:
          - dbt deps
          - dbt build